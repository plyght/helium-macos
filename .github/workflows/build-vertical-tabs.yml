name: Build macOS Helium with Vertical Tabs (PR #68)

on:
  workflow_dispatch:
    inputs:
      runner:
        required: false
        description: "Runner image name"
        default: "macos-14"
      arch:
        required: false
        description: "Architecture to build (arm64, x86_64, or both)"
        default: "arm64"
        type: choice
        options:
          - arm64
          - x86_64
          - both
      do-release:
        required: false
        type: boolean
        description: "Create a release after build is done"
        default: false

permissions:
  contents: write

jobs:
  build-arm64:
    if: ${{ inputs.arch == 'arm64' || inputs.arch == 'both' }}
    name: Build macOS Helium (arm64) with Vertical Tabs
    uses: ./.github/workflows/building-vertical-tabs.yml
    secrets: inherit
    with:
      arch: arm64
      os: ${{ inputs.runner }}

  build-x86_64:
    if: ${{ inputs.arch == 'x86_64' || inputs.arch == 'both' }}
    name: Build macOS Helium (x86_64) with Vertical Tabs
    uses: ./.github/workflows/building-vertical-tabs.yml
    secrets: inherit
    with:
      arch: x86_64
      os: ${{ inputs.runner }}

  release:
    needs: [build-arm64, build-x86_64]
    if: ${{ always() && inputs.do-release && (needs.build-arm64.result == 'success' || needs.build-x86_64.result == 'success') }}
    name: Release macOS binaries of Helium with Vertical Tabs
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          fetch-tags: true
      - name: Checkout vertical-tabs branch for helium-chromium submodule
        run: |
          git submodule update --init
          cd helium-chromium
          git remote add vertical-tabs https://x-access-token:${{ github.token }}@github.com/thenhnn/helium.git || true
          git fetch vertical-tabs nhnn/vertical-tabs
          git checkout FETCH_HEAD
      - name: Copy GitHub specific scripts to git-root folder
        run: cp -va ./.github/scripts/ ./
      - name: Disable Spotlight
        run: sudo mdutil -a -i off
      - name: Install coreutils
        run: brew install coreutils
      - name: Prepare release
        id: bake
        run: ./github_prepare_release.sh | tee -a github_actions_release.log
      - name: Get built x86-64 binary
        if: ${{ inputs.arch == 'x86_64' || inputs.arch == 'both' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.bake.outputs.x64_file_name }}
      - name: Get built arm64 binary
        if: ${{ inputs.arch == 'arm64' || inputs.arch == 'both' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.bake.outputs.arm64_file_name }}
      - name: List files
        run: ls -la
      - name: Generate release note
        run: ./github_generate_release_note.sh | tee -a github_actions_release.log
      - name: List deltas
        id: list_deltas
        run: |
          {
            echo 'deltas<<EOF'
            find ./release_asset/ -name '*.delta'
            echo EOF
          } >> "$GITHUB_OUTPUT"
      - name: Release Helium binaries
        uses: imputnet/action-gh-release@v2.5
        with:
          body_path: ./github_release_note.md
          draft: false
          prerelease: true
          files: |
            ./release_asset/${{ steps.bake.outputs.arm64_file_name }}
            ./release_asset/${{ steps.bake.outputs.x64_file_name }}
            ${{ steps.list_deltas.outputs.deltas }}
          name: ${{ steps.bake.outputs.release_name }} (Vertical Tabs)
          tag_name: ${{ steps.bake.outputs.release_tag_version }}-vertical-tabs
          token: ${{ secrets.GITHUB_TOKEN }}
